name: 'Foundry VTT Module Bundle Analysis'
description: 'Analyze bundle size changes in pull requests for Foundry VTT modules'
author: 'David Raynes'

inputs:
  node-version:
    description: 'Node.js version to use'
    required: false
    default: '18'
  
  github-packages:
    description: 'Enable GitHub Packages registry authentication'
    required: false
    default: 'false'
  
  pattern:
    description: 'Glob pattern for files to analyze'
    required: false
    default: './dist/**/*.{js,css}'
  
  exclude:
    description: 'Glob pattern for files to exclude from analysis'
    required: false
    default: '{./dist/**/*.map,./dist/**/*.d.ts}'
  
  strip-hash:
    description: 'Regex pattern to strip hashes from filenames for comparison'
    required: false
    default: '\\.[a-f0-9]{8}\\.'
  
  minimum-change-threshold:
    description: 'Minimum change in bytes to report'
    required: false
    default: '100'

runs:
  using: 'composite'
  steps:
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ inputs.node-version }}
        cache: 'npm'
        registry-url: ${{ inputs.github-packages == 'true' && 'https://npm.pkg.github.com' || '' }}

    - name: Install dependencies
      shell: bash
      run: npm ci
      env:
        NODE_AUTH_TOKEN: ${{ inputs.github-packages == 'true' && github.token || '' }}

    - name: Build module
      shell: bash
      run: npm run build

    - name: Analyze Bundle Size
      uses: preactjs/compressed-size-action@v2
      with:
        repo-token: ${{ github.token }}
        pattern: ${{ inputs.pattern }}
        exclude: ${{ inputs.exclude }}
        strip-hash: ${{ inputs.strip-hash }}
        minimum-change-threshold: ${{ inputs.minimum-change-threshold }}